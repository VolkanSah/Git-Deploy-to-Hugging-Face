name: Secure HF Deployment

on:
  release:
    types: [created]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Für vollständigen Git-Verlauf

      - name: Setup Git (Anonymisiert)
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Push to Hugging Face
        env:
          HF_REPO: "https://Alibrown:${{ secrets.HF_API_TOKEN }}@huggingface.co/spaces/Alibrown/Git-Deploy-to-Hugging-Face"
        run: |
          # Sicherer Remote-Transport
          git remote add hf "$HF_REPO"
          
          # Atomic Push ohne Historie-Konflikte
          git push hf HEAD:main --force-with-lease 2>&1 | tee push.log
          
          # Token-Sanitisierung für Logs
          sed -i "s/${{ secrets.HF_API_TOKEN }}/******/g" push.log
          cat push.log

      - name: Verify Token Usage
        run: |
          if grep -q "Authentication failed" push.log; then
            echo "::error::Invalid HF Token! Check permissions and validity."
            exit 1
          fi
